# Runic Return Spell - tag for teleporting to / removing a Return Point
execute as @s[tag=RunicSpellStartup,scores={rr.spell.SpellStart=0},tag=RunicReturnSet] at @s run tag @s add RunicReturnSpell
execute as @s[tag=RunicSpellStartup,scores={rr.spell.SpellStart=0},tag=RunicReturnSet] at @s run tag @s add RunicReturnActive
execute as @s[tag=RunicReturnSpell,scores={rr.spell.SpellStore=1..}] at @s run scoreboard players set @s rr.spell.SpellStore 0
execute as @s[tag=RunicSpellStartup,tag=RunicReturnSpell,tag=RunicReturning] at @s run tag @s remove RunicReturning
execute as @s[tag=RunicSpellStartup,tag=RunicReturnSpell] at @s run tag @s remove RunicSpellStartup


# Execution of the Spell - Teleporting to Return Point
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run particle poof ~ ~1 ~ 0.25 0.75 0.25 0.0 20 force @a[distance=..50]
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]},tag=!RunicSilentSpells] at @s run playsound minecraft:entity.ghast.shoot master @a[distance=..20] ~ ~ ~ 0.75 2 0
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]},tag=!RunicSilentSpells] at @s run playsound minecraft:block.enchantment_table.use master @a[distance=..20] ~ ~ ~ 1 1.75 0
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run execute at @e[type=marker,tag=RunicReturnPoint] if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID1 = @s rr.system.playerUUID1 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID2 = @s rr.system.playerUUID2 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID3 = @s rr.system.playerUUID3 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID4 = @s rr.system.playerUUID4 run tp @s ~ ~ ~
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run particle poof ~ ~1 ~ 0.25 0.75 0.25 0.0 20 force @a[distance=..50]
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]},tag=!RunicSilentSpells] at @s run playsound minecraft:entity.ghast.shoot master @a[distance=..20] ~ ~ ~ 0.75 2 0
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]},tag=!RunicSilentSpells] at @s run playsound minecraft:block.enchantment_table.use master @a[distance=..20] ~ ~ ~ 1 1.75 0
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]},tag=!RunicSilentSpells] at @s run playsound minecraft:block.respawn_anchor.deplete master @a[distance=..20] ~ ~ ~ 1 0.75 0
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run scoreboard players remove @s rr.system.Timer 150
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run scoreboard players add @s rr.spell.MemTCD 150
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run tag @s remove RunicReturnNoMove
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=!RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run tag @s remove RunicSpellStarted
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=!RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run tag @s remove RunicCasting
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,tag=!RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run tag @s remove RunicSpellRun
execute as @s[tag=RunicReturnSpell,tag=!RunicSpellRun,scores={rr.spell.SpellStart=0},tag=!RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run tag @s remove RunicReturnSpell
scoreboard players set @s[tag=!RunicReturnSpell,tag=!RunicSpellRun,scores={rr.spell.SpellStart=0},tag=!RunicReturnNoMove,nbt=!{Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] rr.spell.SpellID 0


# Execution of the Spell - Removing the User's Return Point
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,nbt={Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run particle smoke ~ ~1 ~ 0.5 1 0.5 0.03 10 force @a[distance=..40]
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,nbt={Inventory:[{Slot:-106b,id:"minecraft:coal"}]},tag=!RunicSilentSpells] at @s run playsound minecraft:block.beacon.deactivate player @a[distance=..40] ~ ~ ~ 1 1.5 0
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,nbt={Inventory:[{Slot:-106b,id:"minecraft:coal"}]},tag=!RunicSilentSpells] at @s run playsound minecraft:block.respawn_anchor.set_spawn player @a[distance=..40] ~ ~ ~ 1 0.8 0
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,nbt={Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run execute at @e[type=marker,tag=RunicReturnPoint] if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID1 = @s rr.system.playerUUID1 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID2 = @s rr.system.playerUUID2 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID3 = @s rr.system.playerUUID3 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID4 = @s rr.system.playerUUID4 run tellraw @s [{"text":"[Runic Resurgence] ","color":"gray","italic":false},{"text":"Removed Return Point! You will need to set a new one before you can teleport again.","color":"light_purple"}]

execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,nbt={Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run execute at @e[type=marker,tag=RunicReturnPoint] if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID1 = @s rr.system.playerUUID1 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID2 = @s rr.system.playerUUID2 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID3 = @s rr.system.playerUUID3 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID4 = @s rr.system.playerUUID4 run forceload remove ~ ~ ~ ~

execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,nbt={Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run execute at @e[type=marker,tag=RunicReturnPoint] if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID1 = @s rr.system.playerUUID1 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID2 = @s rr.system.playerUUID2 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID3 = @s rr.system.playerUUID3 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID4 = @s rr.system.playerUUID4 run execute as @e[type=marker,tag=RunicReturnPoint,distance=0.5..] at @s run forceload add ~ ~ ~ ~

execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,nbt={Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run execute at @e[type=marker,tag=RunicReturnPoint] if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID1 = @s rr.system.playerUUID1 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID2 = @s rr.system.playerUUID2 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID3 = @s rr.system.playerUUID3 if score @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1] rr.system.matchUUID4 = @s rr.system.playerUUID4 run kill @e[type=marker,tag=RunicReturnPoint,limit=1,sort=nearest,distance=..0.1]
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=RunicReturnSet,nbt={Inventory:[{Slot:-106b,id:"minecraft:coal"}]}] at @s run tag @s remove RunicReturnSet
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=!RunicReturnSet] at @s run tag @s remove RunicSpellStarted
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=!RunicReturnSet] at @s run tag @s remove RunicCasting
execute as @s[tag=RunicReturnSpell,tag=RunicSpellRun,tag=!RunicReturnSet] at @s run tag @s remove RunicSpellRun
execute as @s[tag=RunicReturnSpell,tag=!RunicRetunSet,tag=!RunicSpellRun,scores={rr.spell.SpellStart=0}] at @s run tag @s remove RunicReturnSpell
scoreboard players set @s[tag=!RunicReturnSpell,tag=!RunicSpellRun,scores={rr.spell.SpellStart=0}] rr.spell.SpellID 0